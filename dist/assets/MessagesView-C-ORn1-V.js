import{a as e}from"./rolldown-runtime-DDUpfMIz.js";import{C as t,Ft as n,Gt as r,Kt as i,Mt as a,Nt as o,Pt as s,S as c,Ut as l,X as u,Xt as d,Yt as f,Z as ee,an as te,bt as ne,ft as re,in as ie,jt as p,pt as ae,rn as oe,rt as se,sn as m,z as ce}from"./vendor-B3HL14pl.js";import{en as le}from"./libs-v5ruOQjS.js";import"./supabase-DoaD7gz2.js";import{S as h,T as ue,b as g,c as _,h as de,i as fe,r as pe,u as me,v,w as y,x as b}from"./index-AqHGfiHH.js";var x=e(m(),1),S=l();const C=e=>[`messages`,e],he=(e,t)=>{let n=(0,S.c)(9),i=t||``,a;n[0]===i?a=n[1]:(a=C(i),n[0]=i,n[1]=a);let o=!!e&&!!t,s;n[2]!==e||n[3]!==t?(s=async n=>{let{pageParam:r}=n,i=r===void 0?0:r;if(!e||!t)throw Error(`IDs required`);let a=i*20,o=a+19,{data:s,error:c}=await v.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!1}).range(a,o);if(c)throw c;return s},n[2]=e,n[3]=t,n[4]=s):s=n[4];let c;return n[5]!==a||n[6]!==o||n[7]!==s?(c={queryKey:a,enabled:o,initialPageParam:0,queryFn:s,getNextPageParam:ge},n[5]=a,n[6]=o,n[7]=s,n[8]=c):c=n[8],r(c)};function ge(e,t){return e.length===20?t.length:void 0}var w=l();const T=[`conversations`],_e=e=>{let t=(0,w.c)(5),n=!!e,i;t[0]===e?i=t[1]:(i=async t=>{let{pageParam:n}=t,r=n===void 0?0:n;if(!e)return[];let i=r*100,a=i+99,{data:o,error:s}=await v.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1}).range(i,a);if(s)throw console.error(`Error fetching conversations`,s),s;return o},t[0]=e,t[1]=i);let a;return t[2]!==n||t[3]!==i?(a={queryKey:T,enabled:n,initialPageParam:0,queryFn:i,getNextPageParam:E},t[2]=n,t[3]=i,t[4]=a):a=t[4],r(a)},ve=(e,t)=>{let n=new Map;return e.flat().forEach(e=>{let r=e.sender_id===t?e.receiver:e.sender;r&&!n.has(r.username)&&n.set(r.username,{id:r.id,username:r.username,name:r.full_name||r.username,avatar:r.avatar_url||``,isVerified:r.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(n.values())};function E(e,t){return e.length===100?t.length:void 0}var D=l(),O=e(le(),1);const ye=()=>{let e=(0,D.c)(2),t=f(),n;return e[0]===t?n=e[1]:(n={mutationFn:k,onMutate:async e=>{let n=C(e.receiverId);await t.cancelQueries({queryKey:n});let r=t.getQueryData(n);if(r){let i={id:`optimistic-`+(0,O.default)().valueOf(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content||null,media_url:e.mediaUrl||null,is_read:!1,created_at:(0,O.default)().toISOString()};t.setQueryData(n,{...r,pages:r.pages.map((e,t)=>t===0?[i,...e]:e)})}return{previousMessages:r}},onError:(e,n,r)=>{r?.previousMessages&&t.setQueryData(C(n.receiverId),r.previousMessages),console.error(e)},onSettled:(e,n,r)=>{t.invalidateQueries({queryKey:C(r.receiverId)}),t.invalidateQueries({queryKey:[`conversations`]})}},e[0]=t,e[1]=n),i(n)};async function k(e){let{content:t,senderId:n,receiverId:r,mediaUrl:i}=e,{data:a,error:o}=await v.from(`messages`).insert({sender_id:n,receiver_id:r,content:t||null,media_url:i||null}).select().single();if(o)throw o;return a}var A=l();const be=()=>{let e=(0,A.c)(2),t=f(),n;return e[0]===t?n=e[1]:(n={mutationFn:j,onSuccess:(e,n)=>{let{senderId:r}=n;t.invalidateQueries({queryKey:C(r)}),t.invalidateQueries({queryKey:[`conversations`]})}},e[0]=t,e[1]=n),i(n)};async function j(e){let{senderId:t,receiverId:n}=e,{error:r}=await v.from(`messages`).update({is_read:!0}).eq(`sender_id`,t).eq(`receiver_id`,n).eq(`is_read`,!1);if(r)throw r}var M=l();const xe=e=>{let t=(0,M.c)(10),{user:n,profile:r}=y(),i;t[0]===Symbol.for(`react.memo_cache_sentinel`)?(i=[],t[0]=i):i=t[0];let[a,o]=(0,x.useState)(i),s=(0,x.useRef)(null),c,l;t[1]!==e||t[2]!==n?(c=()=>{if(!n||!e)return;let t=v.channel(`typing:${e}`,{config:{presence:{key:n.id}}});return s.current=t,t.on(`presence`,{event:`sync`},()=>{let e=t.presenceState(),n=[];Object.keys(e).forEach(t=>{e[t].forEach(e=>{e.isTyping&&e.username&&n.push(e.username)})}),o([...new Set(n)])}).subscribe(),()=>{v.removeChannel(t),s.current=null}},l=[e,n],t[1]=e,t[2]=n,t[3]=c,t[4]=l):(c=t[3],l=t[4]),(0,x.useEffect)(c,l);let u;t[5]===r?.username?u=t[6]:(u=async e=>{s.current&&await s.current.track({isTyping:e,username:r?.username,online_at:new Date().toISOString()})},t[5]=r?.username,t[6]=u);let d=u,f;return t[7]!==d||t[8]!==a?(f={typingUsers:a,setTyping:d},t[7]=d,t[8]=a,t[9]=f):f=t[9],f};var N=e(d(),1),P=()=>{let{theme:e,showToast:r}=ue(),{user:i,profile:l}=y(),d=f(),m=ie(),le=oe(),{username:S}=te(),{data:ge}=de(S||``,i?.id),w=le.state?.user||ge?.user||null,[T,E]=(0,x.useState)(``),[D,O]=(0,x.useState)(``),[k,A]=(0,x.useState)([]),[j,M]=(0,x.useState)(!1),[P,F]=(0,x.useState)(!1),[I,L]=(0,x.useState)(!1),R=(0,x.useRef)(null),z=(0,x.useRef)(null),B=(0,x.useRef)(null),[Se,V]=(0,x.useState)(!1),H=e===`dark`?`border-zinc-800`:`border-zinc-200`,U=e===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`;(0,x.useEffect)(()=>{let e=e=>{B.current&&!B.current.contains(e.target)&&L(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]),(0,x.useEffect)(()=>{let e=setTimeout(async()=>{if(D.trim().length>0){M(!0);let{data:e}=await v.from(`profiles`).select(`id, username, full_name, avatar_url, is_verified`).ilike(`username`,`%${D}%`).limit(10);e&&A(e.map(e=>({id:e.id,username:e.username,name:e.full_name||e.username,avatar:e.avatar_url||``,isVerified:e.is_verified||!1}))),M(!1)}else A([])},300);return()=>clearTimeout(e)},[D]);let{data:W,fetchNextPage:Ce,hasNextPage:we}=_e(i?.id),G=x.useMemo(()=>!W||!i?.id?[]:ve(W.pages,i.id),[W,i?.id]),K=w?.id||G.find(e=>e.username===w?.username)?.id,{data:q,fetchNextPage:Te,hasNextPage:Ee,isFetchingNextPage:De}=he(i?.id,K),J=x.useMemo(()=>q?[...q.pages.flat()].reverse():[],[q]),{mutate:Y}=ye(),{mutate:Oe}=be(),{typingUsers:X,setTyping:Z}=xe(K?[i?.id,K].sort().join(`-`):``);(0,x.useEffect)(()=>{i?.id&&K&&J.length>0&&J.some(e=>e.sender_id===K&&!e.is_read)&&Oe({senderId:K,receiverId:i.id})},[J,K,i?.id,Oe]),(0,x.useEffect)(()=>{K&&(T.length>0?Z(!0):Z(!1))},[T,K,Z]),(0,x.useEffect)(()=>{if(!i)return;let e=v.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`*`,schema:`public`,table:`messages`},e=>{if(!e.new)return;let t=e.new;d.invalidateQueries({queryKey:[`conversations`]}),K&&(t.sender_id===K&&t.receiver_id===i.id||t.sender_id===i.id&&t.receiver_id===K)&&d.invalidateQueries({queryKey:C(K)})}).subscribe();return()=>{v.removeChannel(e)}},[i,K,d]);let ke=e=>{E(t=>t+e.emoji)},Ae=()=>{!T.trim()||!K||!i||(Y({content:T,senderId:i.id,receiverId:K}),E(``),Z(!1),L(!1))},je=async e=>{if(!(!i||!K)){F(!0);try{let t=`${`${i.id}-${Date.now()}.webm`}`,{error:n}=await v.storage.from(`messages`).upload(t,e);if(n)throw n;let{data:{publicUrl:r}}=v.storage.from(`messages`).getPublicUrl(t);Y({senderId:i.id,receiverId:K,mediaUrl:r}),V(!1)}catch(e){r(`ভয়েস মেসেজ পাঠাতে সমস্যা হয়েছে`),console.error(e)}finally{F(!1)}}},Me=async e=>{let t=e.target.files?.[0];if(!(!t||!i||!K)){F(!0);try{let e=t.name.split(`.`).pop(),n=`${`${i.id}-${Date.now()}.${e}`}`,{error:r}=await v.storage.from(`messages`).upload(n,t);if(r)throw r;let{data:{publicUrl:a}}=v.storage.from(`messages`).getPublicUrl(n);Y({senderId:i.id,receiverId:K,mediaUrl:a})}catch(e){r(`ছবি পাঠাতে সমস্যা হয়েছে`),console.error(e)}finally{F(!1),z.current&&(z.current.value=``)}}},Q=(0,x.useRef)(0);(0,x.useEffect)(()=>{J.length>Q.current&&(J[J.length-1]?.sender_id===i?.id||J.length<25)&&R.current?.scrollIntoView({behavior:Q.current===0?`auto`:`smooth`}),Q.current=J.length},[J,X,i?.id]);let $=e=>{m(`/messages/${e.username}`,{state:{user:e}})};return(0,N.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,N.jsxs)(`div`,{className:`w-full h-full md:border ${H} rounded-lg flex overflow-hidden relative shadow-lg`,children:[(0,N.jsxs)(`div`,{className:`w-full md:w-[397px] border-r ${H} flex flex-col absolute md:relative inset-0 z-10 ${e===`dark`?`bg-black`:`bg-white`} ${w?`hidden md:flex`:`flex`}`,children:[(0,N.jsxs)(`div`,{className:`h-[75px] px-5 flex items-center justify-between border-b ${H} shrink-0`,children:[(0,N.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,N.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-1`,onClick:()=>m(`/`),children:(0,N.jsx)(p,{size:28})}),(0,N.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[(0,N.jsx)(`span`,{className:`font-bold text-xl`,children:l?.username}),(0,N.jsx)(a,{size:20})]})]}),(0,N.jsx)(u,{size:24,className:`cursor-pointer`})]}),(0,N.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,N.jsxs)(`div`,{className:`flex items-center gap-2 px-3 py-2 rounded-lg ${e===`dark`?`bg-[#262626]`:`bg-gray-100`}`,children:[(0,N.jsx)(se,{size:16,className:`text-[#8e8e8e]`}),(0,N.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,value:D,onChange:e=>O(e.target.value),className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),D&&(0,N.jsx)(ce,{size:16,className:`cursor-pointer text-[#8e8e8e]`,onClick:()=>O(``)})]})}),(0,N.jsxs)(`div`,{className:`flex-grow overflow-y-auto`,children:[D?(0,N.jsx)(N.Fragment,{children:j?(0,N.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`অনুসন্ধান করা হচ্ছে...`}):k.length===0?(0,N.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`কোনো ফলাফল পাওয়া যায়নি`}):k.map(t=>(0,N.jsxs)(`div`,{onClick:()=>{$(t),O(``)},className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${U}`,children:[(0,N.jsxs)(g,{className:`relative flex-shrink-0 w-14 h-14`,children:[(0,N.jsx)(h,{src:t.avatar}),(0,N.jsx)(b,{children:t.username[0].toUpperCase()})]}),(0,N.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,N.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[t.username,t.isVerified&&(0,N.jsx)(_,{})]}),(0,N.jsx)(`div`,{className:`text-xs truncate ${e===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:t.name})]})]},t.username))}):G.map(t=>(0,N.jsxs)(`div`,{onClick:()=>$(t),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${U} ${w?.username===t.username?e===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,N.jsxs)(g,{className:`relative flex-shrink-0 w-14 h-14`,children:[(0,N.jsx)(h,{src:t.avatar}),(0,N.jsx)(b,{children:t.username[0].toUpperCase()})]}),(0,N.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,N.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[t.username,t.isVerified&&(0,N.jsx)(_,{})]}),(0,N.jsx)(`div`,{className:`text-xs truncate ${e===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},t.username)),we&&(0,N.jsx)(`div`,{className:`p-4 text-center`,children:(0,N.jsx)(`button`,{onClick:()=>Ce(),className:`text-xs text-[#006a4e] font-bold hover:underline`,children:`পুরানো চ্যাট লোড করুন`})})]})]}),(0,N.jsx)(`div`,{className:`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${e===`dark`?`bg-black`:`bg-white`} ${w?`flex`:`hidden md:flex`}`,children:w?(0,N.jsxs)(N.Fragment,{children:[(0,N.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${H} shrink-0`,children:[(0,N.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,N.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>m(`/messages`),children:(0,N.jsx)(p,{size:28})}),(0,N.jsxs)(g,{className:`w-8 h-8 cursor-pointer`,onClick:()=>m(`/profile/${w.username}`),children:[(0,N.jsx)(h,{src:w.avatar}),(0,N.jsx)(b,{children:w.username[0].toUpperCase()})]}),(0,N.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>m(`/profile/${w.username}`),children:[w.username,w.isVerified&&(0,N.jsx)(_,{})]})]}),(0,N.jsx)(`div`,{className:`flex items-center gap-4`,children:(0,N.jsx)(ne,{size:24,className:`cursor-pointer`})})]}),(0,N.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[Ee&&(0,N.jsx)(`div`,{className:`flex justify-center py-2`,children:(0,N.jsx)(`button`,{onClick:()=>Te(),disabled:De,className:`text-xs text-[#006a4e] font-bold py-1 px-3 rounded-full bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors`,children:De?`লোড হচ্ছে...`:`পুরানো মেসেজ দেখুন`})}),J.map((t,n)=>(0,N.jsxs)(`div`,{className:`flex flex-col gap-1 max-w-[85%] ${t.sender_id===i?.id?`self-end items-end`:`self-start items-start`}`,children:[t.media_url&&(0,N.jsx)(`div`,{className:`rounded-2xl overflow-hidden mb-1 border border-zinc-800`,children:t.media_url.endsWith(`.webm`)?(0,N.jsx)(pe,{src:t.media_url.includes(`/storage/v1/object/messages/`)&&!t.media_url.includes(`/storage/v1/object/public/`)?t.media_url.replace(`/storage/v1/object/messages/`,`/storage/v1/object/public/messages/`):t.media_url,theme:e}):(0,N.jsx)(me,{src:t.media_url.includes(`/storage/v1/object/messages/`)&&!t.media_url.includes(`/storage/v1/object/public/`)?t.media_url.replace(`/storage/v1/object/messages/`,`/storage/v1/object/public/messages/`):t.media_url,width:300,className:`max-w-full h-auto max-h-[300px] object-cover`,alt:`Shared image`})}),t.content&&(0,N.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${t.sender_id===i?.id?`bg-[#006a4e] text-white`:e===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:t.content}),t.sender_id===i?.id&&(0,N.jsx)(`div`,{className:`text-[10px] text-gray-500 flex items-center gap-1`,children:t.is_read?(0,N.jsx)(s,{size:12,className:`text-blue-500`}):(0,N.jsx)(o,{size:12})})]},t.id||n)),(0,N.jsx)(`div`,{ref:R}),X.length>0&&(0,N.jsxs)(`div`,{className:`text-xs text-gray-500 px-4 pb-2 animate-pulse`,children:[X.join(`, `),` টাইপ করছে...`]})]}),(0,N.jsxs)(`div`,{className:`p-4 shrink-0 relative`,children:[I&&(0,N.jsx)(`div`,{ref:B,className:`absolute bottom-20 left-4 z-50 shadow-2xl`,children:(0,N.jsx)(t,{theme:e===`dark`?c.DARK:c.LIGHT,onEmojiClick:ke,lazyLoadEmojis:!0,skinTonesDisabled:!0,searchDisabled:!1})}),Se?(0,N.jsx)(`div`,{className:`p-2 border ${H} rounded-[24px] ${e===`dark`?`bg-black`:`bg-white`}`,children:(0,N.jsx)(fe,{onRecordingComplete:je,onCancel:()=>V(!1)})}):(0,N.jsxs)(`form`,{className:`border ${H} rounded-[24px] min-h-[44px] flex items-end gap-1 p-1 ${e===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),Ae()},children:[(0,N.jsx)(`div`,{className:`p-2 shrink-0 cursor-pointer transition-colors rounded-full ${e===`dark`?`hover:bg-zinc-800 text-zinc-400`:`hover:bg-gray-100 text-zinc-500`}`,onClick:()=>L(!I),children:(0,N.jsx)(ee,{size:24})}),!T.trim()&&(0,N.jsxs)(N.Fragment,{children:[(0,N.jsxs)(`div`,{className:`p-2 shrink-0 cursor-pointer transition-colors rounded-full relative overflow-hidden ${e===`dark`?`hover:bg-zinc-800 text-zinc-400`:`hover:bg-gray-100 text-zinc-500`}`,children:[(0,N.jsx)(n,{size:24}),(0,N.jsx)(`input`,{type:`file`,ref:z,accept:`image/*`,className:`absolute inset-0 opacity-0 cursor-pointer`,onChange:Me,disabled:P})]}),(0,N.jsx)(`div`,{className:`p-2 shrink-0 cursor-pointer transition-colors rounded-full ${e===`dark`?`hover:bg-zinc-800 text-zinc-400`:`hover:bg-gray-100 text-zinc-500`}`,onClick:()=>V(!0),children:(0,N.jsx)(re,{size:24})})]}),(0,N.jsx)(`div`,{className:`flex-grow flex items-center min-w-0 h-full py-1`,children:(0,N.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:T,onChange:e=>E(e.target.value),onFocus:()=>L(!1),className:`bg-transparent border-none outline-none text-sm w-full px-2 py-1 ${e===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`})}),T.trim()||P?(0,N.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-3 py-2 shrink-0 cursor-pointer hover:text-blue-600 disabled:opacity-50 transition-colors`,disabled:!T.trim()&&!P||P,children:P?`...`:`পাঠান`}):null]})]})]}):(0,N.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,N.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${e===`dark`?`border-white`:`border-black`}`,children:(0,N.jsx)(ae,{size:48,strokeWidth:1})}),(0,N.jsxs)(`div`,{children:[(0,N.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,N.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>r(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]})})]})})};export{P as default};