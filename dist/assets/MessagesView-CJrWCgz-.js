import{a as e}from"./rolldown-runtime-Cn8xt2Gj.js";import{Ft as t,Gt as n,It as r,K as i,Mt as a,N as o,Nt as s,Ut as c,V as l,Wt as u,_t as d,bt as f,et as ee,kt as p,qt as m,st as h,vt as te,xt as g,yt as _}from"./vendor-B5OVd975.js";import{tn as v}from"./libs-Bghk4o3g.js";import"./tanstack-DEYdLxKO.js";import"./supabase-nYr-R5G6.js";import{_ as y,a as b,d as ne,m as x,v as S,y as C}from"./index-DLt9WKqV.js";var w=m(),T=p();const E=e=>[`messages`,e],re=(e,t)=>{let n=(0,T.c)(9),r=t||``,i;n[0]===r?i=n[1]:(i=E(r),n[0]=r,n[1]=i);let a=!!e&&!!t,o;n[2]!==e||n[3]!==t?(o=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await x.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},n[2]=e,n[3]=t,n[4]=o):o=n[4];let c;return n[5]!==i||n[6]!==a||n[7]!==o?(c={queryKey:i,enabled:a,queryFn:o},n[5]=i,n[6]=a,n[7]=o,n[8]=c):c=n[8],s(c)};var D=p();const O=[`conversations`],ie=e=>{let t=(0,D.c)(5),n=!!e,r;t[0]===e?r=t[1]:(r=async()=>{if(!e)return[];let{data:t,error:n}=await x.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,isVerified:n.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=r);let i;return t[2]!==n||t[3]!==r?(i={queryKey:O,enabled:n,queryFn:r},t[2]=n,t[3]=r,t[4]=i):i=t[4],s(i)};var k=p(),A=e(v(),1);const j=()=>{let e=(0,k.c)(2),n=t(),r;return e[0]===n?r=e[1]:(r={mutationFn:M,onMutate:async e=>{let t=E(e.receiverId);await n.cancelQueries({queryKey:t});let r=n.getQueryData(t);return r&&n.setQueryData(t,[...r,{id:`optimistic-`+(0,A.default)().valueOf(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content||null,media_url:e.mediaUrl||null,is_read:!1,created_at:(0,A.default)().toISOString()}]),{previousMessages:r}},onError:(e,t,r)=>{r?.previousMessages&&n.setQueryData(E(t.receiverId),r.previousMessages),console.error(e)},onSettled:(e,t,r)=>{n.invalidateQueries({queryKey:E(r.receiverId)}),n.invalidateQueries({queryKey:[`conversations`]})}},e[0]=n,e[1]=r),a(r)};async function M(e){let{content:t,senderId:n,receiverId:r,mediaUrl:i}=e,{data:a,error:o}=await x.from(`messages`).insert({sender_id:n,receiver_id:r,content:t||null,media_url:i||null}).select().single();if(o)throw o;return a}var N=p();const ae=()=>{let e=(0,N.c)(2),n=t(),r;return e[0]===n?r=e[1]:(r={mutationFn:P,onSuccess:(e,t)=>{let{senderId:r}=t;n.invalidateQueries({queryKey:E(r)}),n.invalidateQueries({queryKey:[`conversations`]})}},e[0]=n,e[1]=r),a(r)};async function P(e){let{senderId:t,receiverId:n}=e,{error:r}=await x.from(`messages`).update({is_read:!0}).eq(`sender_id`,t).eq(`receiver_id`,n).eq(`is_read`,!1);if(r)throw r}var F=p();const I=e=>{let t=(0,F.c)(10),{user:n,profile:r}=S(),i;t[0]===Symbol.for(`react.memo_cache_sentinel`)?(i=[],t[0]=i):i=t[0];let[a,o]=(0,w.useState)(i),s=(0,w.useRef)(null),c,l;t[1]!==e||t[2]!==n?(c=()=>{if(!n||!e)return;let t=x.channel(`typing:${e}`,{config:{presence:{key:n.id}}});return s.current=t,t.on(`presence`,{event:`sync`},()=>{let e=t.presenceState(),r=[];Object.keys(e).forEach(t=>{t!==n.id&&e[t].forEach(e=>{e.isTyping&&e.username&&r.push(e.username)})}),o([...new Set(r)])}).subscribe(),()=>{x.removeChannel(t),s.current=null}},l=[e,n],t[1]=e,t[2]=n,t[3]=c,t[4]=l):(c=t[3],l=t[4]),(0,w.useEffect)(c,l);let u;t[5]===r?.username?u=t[6]:(u=async e=>{s.current&&await s.current.track({isTyping:e,username:r?.username,online_at:new Date().toISOString()})},t[5]=r?.username,t[6]=u);let d=u,f;return t[7]!==d||t[8]!==a?(f={typingUsers:a,setTyping:d},t[7]=d,t[8]=a,t[9]=f):f=t[9],f};var L=r(),R=()=>{let{theme:e,showToast:r}=C(),{user:a,profile:s}=S(),p=t(),m=u(),v=c(),{username:T}=n(),D=`bg-[#006a4e] hover:bg-[#00523c]`,{data:O}=ne(T||``,a?.id),k=v.state?.user||O?.user||null,[A,M]=(0,w.useState)(``),[N,P]=(0,w.useState)(``),[F,R]=(0,w.useState)([]),[oe,z]=(0,w.useState)(!1),[B,V]=(0,w.useState)(!1),H=(0,w.useRef)(null),U=(0,w.useRef)(null),W=e===`dark`?`border-zinc-800`:`border-zinc-200`,G=e===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`;(0,w.useEffect)(()=>{let e=setTimeout(async()=>{if(N.trim().length>0){z(!0);let{data:e}=await x.from(`profiles`).select(`id, username, full_name, avatar_url, is_verified`).ilike(`username`,`%${N}%`).limit(10);e&&R(e.map(e=>({id:e.id,username:e.username,name:e.full_name||e.username,avatar:e.avatar_url||``,isVerified:e.is_verified||!1}))),z(!1)}else R([])},300);return()=>clearTimeout(e)},[N]);let{data:K=[]}=ie(a?.id),q=k?.id||K.find(e=>e.username===k?.username)?.id,{data:se}=re(a?.id,q),J=se||[],{mutate:Y}=j(),{mutate:X}=ae(),{typingUsers:Z,setTyping:Q}=I(q?[a?.id,q].sort().join(`-`):``);(0,w.useEffect)(()=>{a?.id&&q&&J.length>0&&J.some(e=>e.sender_id===q&&!e.is_read)&&X({senderId:q,receiverId:a.id})},[J,q,a?.id,X]),(0,w.useEffect)(()=>{q&&(A.length>0?Q(!0):Q(!1))},[A,q,Q]),(0,w.useEffect)(()=>{if(!a)return;let e=x.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`*`,schema:`public`,table:`messages`},e=>{let t=e.new;p.invalidateQueries({queryKey:[`conversations`]}),q&&(t.sender_id===q&&t.receiver_id===a.id||t.sender_id===a.id&&t.receiver_id===q)&&p.invalidateQueries({queryKey:E(q)})}).subscribe();return()=>{x.removeChannel(e)}},[a,q,p]);let ce=()=>{!A.trim()||!q||!a||(Y({content:A,senderId:a.id,receiverId:q}),M(``),Q(!1))},le=async e=>{let t=e.target.files?.[0];if(!(!t||!a||!q)){V(!0);try{let e=t.name.split(`.`).pop(),n=`${`${a.id}-${Date.now()}.${e}`}`,{error:r}=await x.storage.from(`messages`).upload(n,t);if(r)throw r;let{data:{publicUrl:i}}=x.storage.from(`messages`).getPublicUrl(n);Y({senderId:a.id,receiverId:q,mediaUrl:i})}catch(e){r(`ছবি পাঠাতে সমস্যা হয়েছে`),console.error(e)}finally{V(!1),U.current&&(U.current.value=``)}}};(0,w.useEffect)(()=>{H.current?.scrollIntoView({behavior:`smooth`})},[J,Z]);let $=e=>{m(`/messages/${e.username}`,{state:{user:e}})};return(0,L.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,L.jsxs)(`div`,{className:`w-full h-full md:border ${W} rounded-lg flex overflow-hidden relative shadow-lg`,children:[(0,L.jsxs)(`div`,{className:`w-full md:w-[397px] border-r ${W} flex flex-col absolute md:relative inset-0 z-10 ${e===`dark`?`bg-black`:`bg-white`} ${k?`hidden md:flex`:`flex`}`,children:[(0,L.jsxs)(`div`,{className:`h-[75px] px-5 flex items-center justify-between border-b ${W} shrink-0`,children:[(0,L.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,L.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-1`,onClick:()=>m(`/`),children:(0,L.jsx)(d,{size:28})}),(0,L.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[(0,L.jsx)(`span`,{className:`font-bold text-xl`,children:s?.username}),(0,L.jsx)(te,{size:20})]})]}),(0,L.jsx)(l,{size:24,className:`cursor-pointer`})]}),(0,L.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,L.jsxs)(`div`,{className:`flex items-center gap-2 px-3 py-2 rounded-lg ${e===`dark`?`bg-[#262626]`:`bg-gray-100`}`,children:[(0,L.jsx)(i,{size:16,className:`text-[#8e8e8e]`}),(0,L.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,value:N,onChange:e=>P(e.target.value),className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),N&&(0,L.jsx)(o,{size:16,className:`cursor-pointer text-[#8e8e8e]`,onClick:()=>P(``)})]})}),(0,L.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:N?(0,L.jsx)(L.Fragment,{children:oe?(0,L.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`অনুসন্ধান করা হচ্ছে...`}):F.length===0?(0,L.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`কোনো ফলাফল পাওয়া যায়নি`}):F.map(t=>(0,L.jsxs)(`div`,{onClick:()=>{$(t),P(``)},className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${G}`,children:[(0,L.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,L.jsx)(y,{src:t.avatar,className:`w-full h-full`,alt:t.username})}),(0,L.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,L.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[t.username,t.isVerified&&(0,L.jsx)(b,{})]}),(0,L.jsx)(`div`,{className:`text-xs truncate ${e===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:t.name})]})]},t.username))}):K.map(t=>(0,L.jsxs)(`div`,{onClick:()=>$(t),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${G} ${k?.username===t.username?e===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,L.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,L.jsx)(y,{src:t.avatar,className:`w-full h-full`,alt:t.username})}),(0,L.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,L.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[t.username,t.isVerified&&(0,L.jsx)(b,{})]}),(0,L.jsx)(`div`,{className:`text-xs truncate ${e===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},t.username))})]}),(0,L.jsx)(`div`,{className:`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${e===`dark`?`bg-black`:`bg-white`} ${k?`flex`:`hidden md:flex`}`,children:k?(0,L.jsxs)(L.Fragment,{children:[(0,L.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${W} shrink-0`,children:[(0,L.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,L.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>m(`/messages`),children:(0,L.jsx)(d,{size:28})}),(0,L.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>m(`/profile/${k.username}`),children:(0,L.jsx)(y,{src:k.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,L.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>m(`/profile/${k.username}`),children:[k.username,k.isVerified&&(0,L.jsx)(b,{})]})]}),(0,L.jsx)(`div`,{className:`flex items-center gap-4`,children:(0,L.jsx)(h,{size:24,className:`cursor-pointer`})})]}),(0,L.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[J.map((t,n)=>(0,L.jsxs)(`div`,{className:`flex flex-col gap-1 max-w-[85%] ${t.sender_id===a?.id?`self-end items-end`:`self-start items-start`}`,children:[t.media_url&&(0,L.jsx)(`div`,{className:`rounded-2xl overflow-hidden mb-1 border border-zinc-800`,children:(0,L.jsx)(y,{src:t.media_url,width:300,className:`max-w-full h-auto max-h-[300px] object-cover`,alt:`Shared image`})}),t.content&&(0,L.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${t.sender_id===a?.id?`bg-[#006a4e] text-white`:e===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:t.content}),t.sender_id===a?.id&&(0,L.jsx)(`div`,{className:`text-[10px] text-gray-500 flex items-center gap-1`,children:t.is_read?(0,L.jsx)(f,{size:12,className:`text-blue-500`}):(0,L.jsx)(_,{size:12})})]},t.id||n)),(0,L.jsx)(`div`,{ref:H}),Z.length>0&&(0,L.jsxs)(`div`,{className:`text-xs text-gray-500 px-4 pb-2 animate-pulse`,children:[Z.join(`, `),` টাইপ করছে...`]})]}),(0,L.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,L.jsxs)(`form`,{className:`border ${W} rounded-full px-2 h-11 flex items-center gap-2 ${e===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),ce()},children:[(0,L.jsxs)(`div`,{className:`${D} rounded-full p-2 cursor-pointer ml-1 text-white relative overflow-hidden`,children:[(0,L.jsx)(g,{size:16,fill:`currentColor`}),(0,L.jsx)(`input`,{type:`file`,ref:U,accept:`image/*`,className:`absolute inset-0 opacity-0 cursor-pointer`,onChange:le,disabled:B})]}),(0,L.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:A,onChange:e=>M(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${e===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,L.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!A.trim()&&!B||B,children:B?`পাঠানো হচ্ছে...`:`পাঠান`})]})})]}):(0,L.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,L.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${e===`dark`?`border-white`:`border-black`}`,children:(0,L.jsx)(ee,{size:48,strokeWidth:1})}),(0,L.jsxs)(`div`,{children:[(0,L.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,L.jsx)(`button`,{className:`${D} text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>r(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]})})]})})};export{R as default};