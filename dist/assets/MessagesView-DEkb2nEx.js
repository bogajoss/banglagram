import{n as e,t}from"./chevron-down-BZ3o0n4E.js";import{A as n,D as r,F as i,I as a,M as o,N as s,O as c,P as ee,S as te,_ as ne,d as re,f as ie,j as ae,k as l,l as u,m as oe,o as se,u as ce,v as le,w as d}from"./index-B9kqV9H8.js";var ue=d(`info`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`path`,{d:`M12 16v-4`,key:`1dtifu`}],[`path`,{d:`M12 8h.01`,key:`e9boi3`}]]),de=d(`phone`,[[`path`,{d:`M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384`,key:`9njp5v`}]]),fe=d(`square-pen`,[[`path`,{d:`M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7`,key:`1m0v6g`}],[`path`,{d:`M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z`,key:`ohrbg2`}]]),f=a(i(),1),pe=r();const p=e=>[`messages`,e],me=(e,t)=>{let n=(0,pe.c)(9),r=t||``,i;n[0]===r?i=n[1]:(i=p(r),n[0]=r,n[1]=i);let a=!!e&&!!t,o;n[2]!==e||n[3]!==t?(o=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await u.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},n[2]=e,n[3]=t,n[4]=o):o=n[4];let s;return n[5]!==i||n[6]!==a||n[7]!==o?(s={queryKey:i,enabled:a,queryFn:o},n[5]=i,n[6]=a,n[7]=o,n[8]=s):s=n[8],l(s)};var he=r();const ge=[`conversations`],_e=e=>{let t=(0,he.c)(5),n=!!e,r;t[0]===e?r=t[1]:(r=async()=>{if(!e)return[];let{data:t,error:n}=await u.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=r);let i;return t[2]!==n||t[3]!==r?(i={queryKey:ge,enabled:n,queryFn:r},t[2]=n,t[3]=r,t[4]=i):i=t[4],l(i)};var m=r();const ve=()=>{let e=(0,m.c)(2),t=n(),r;return e[0]===t?r=e[1]:(r={mutationFn:h,onMutate:async e=>{let n=p(e.receiverId);await t.cancelQueries({queryKey:n});let r=t.getQueryData(n);return r&&t.setQueryData(n,[...r,{id:`optimistic-`+Date.now(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content,media_url:null,is_read:!1,created_at:new Date().toISOString()}]),{previousMessages:r}},onError:(e,n,r)=>{r?.previousMessages&&t.setQueryData(p(n.receiverId),r.previousMessages),console.error(e)},onSettled:(e,n,r)=>{t.invalidateQueries({queryKey:p(r.receiverId)}),t.invalidateQueries({queryKey:[`conversations`]})}},e[0]=t,e[1]=r),c(r)};async function h(e){let{content:t,senderId:n,receiverId:r}=e,{data:i,error:a}=await u.from(`messages`).insert({sender_id:n,receiver_id:r,content:t}).select().single();if(a)throw a;return i}var ye=r(),g=ae(),be=()=>{let r=(0,ye.c)(72),{theme:i,showToast:a}=ie(),{user:c,profile:ae}=re(),l=n(),d=s(),pe=o(),{username:he}=ee(),{data:ge}=se(he||``,c?.id),m=pe.state?.user||ge?.user||null,[h,be]=(0,f.useState)(``),xe=(0,f.useRef)(null),_=i===`dark`?`border-zinc-800`:`border-zinc-200`,v=i===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`,{data:y}=_e(c?.id),b;r[0]===y?b=r[1]:(b=y===void 0?[]:y,r[0]=y,r[1]=b);let x=b,S;r[2]!==x||r[3]!==m?.id||r[4]!==m?.username?(S=m?.id||x.find(e=>e.username===m?.username)?.id,r[2]=x,r[3]=m?.id,r[4]=m?.username,r[5]=S):S=r[5];let C=S,{data:w}=me(c?.id,C),T;r[6]===w?T=r[7]:(T=w===void 0?[]:w,r[6]=w,r[7]=T);let E=T,{mutate:Se}=ve(),D,O;r[8]!==l||r[9]!==C||r[10]!==c?(D=()=>{if(!c)return;let e=u.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`INSERT`,schema:`public`,table:`messages`},e=>{let t=e.new;if(t.receiver_id!==c.id&&t.sender_id!==c.id)return;l.invalidateQueries({queryKey:[`conversations`]}),console.log(`Realtime msg:`,t,`Selected:`,C);let n=t.sender_id===C&&t.receiver_id===c.id||t.sender_id===c.id&&t.receiver_id===C;C&&n&&(l.setQueryData(p(C),e=>e&&e.some(e=>e.id===t.id)?e:e?[...e,t]:[t]),l.invalidateQueries({queryKey:p(C)}))}).subscribe();return()=>{u.removeChannel(e)}},O=[c,C,l],r[8]=l,r[9]=C,r[10]=c,r[11]=D,r[12]=O):(D=r[11],O=r[12]),(0,f.useEffect)(D,O);let k;r[13]!==h||r[14]!==m||r[15]!==C||r[16]!==Se||r[17]!==c?(k=()=>{if(console.log(`Attempting to send message:`,h,C,c?.id,m),!h.trim()||!C||!c){console.warn(`Send aborted: Missing data`,{msg:h,target:C,user:c?.id,selectedObject:m});return}Se({content:h,senderId:c.id,receiverId:C}),be(``)},r[13]=h,r[14]=m,r[15]=C,r[16]=Se,r[17]=c,r[18]=k):k=r[18];let A=k,j;r[19]===Symbol.for(`react.memo_cache_sentinel`)?(j=()=>{xe.current?.scrollIntoView({behavior:`smooth`})},r[19]=j):j=r[19];let M;r[20]===E?M=r[21]:(M=[E],r[20]=E,r[21]=M),(0,f.useEffect)(j,M);let N;r[22]===d?N=r[23]:(N=e=>{d(`/messages/${e.username}`,{state:{user:e}})},r[22]=d,r[23]=N);let P=N,F=`w-full h-full md:border ${_} rounded-lg flex overflow-hidden relative shadow-lg`,I=`w-full md:w-[397px] border-r ${_} flex flex-col absolute md:relative inset-0 z-10 ${i===`dark`?`bg-black`:`bg-white`} ${m?`hidden md:flex`:`flex`}`,L=`h-[75px] px-5 flex items-center justify-between border-b ${_} shrink-0`,R=ae?.username,z;r[24]===R?z=r[25]:(z=(0,g.jsx)(`span`,{className:`font-bold text-xl`,children:R}),r[24]=R,r[25]=z);let B;r[26]===Symbol.for(`react.memo_cache_sentinel`)?(B=(0,g.jsx)(t,{size:20}),r[26]=B):B=r[26];let V;r[27]===z?V=r[28]:(V=(0,g.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[z,B]}),r[27]=z,r[28]=V);let H;r[29]===Symbol.for(`react.memo_cache_sentinel`)?(H=(0,g.jsx)(fe,{size:24,className:`cursor-pointer`}),r[29]=H):H=r[29];let U;r[30]!==L||r[31]!==V?(U=(0,g.jsxs)(`div`,{className:L,children:[V,H]}),r[30]=L,r[31]=V,r[32]=U):U=r[32];let W=`flex items-center gap-2 px-3 py-2 rounded-lg ${i===`dark`?`bg-[#262626]`:`bg-gray-100`}`,G,K;r[33]===Symbol.for(`react.memo_cache_sentinel`)?(G=(0,g.jsx)(ne,{size:16,className:`text-[#8e8e8e]`}),K=(0,g.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),r[33]=G,r[34]=K):(G=r[33],K=r[34]);let q;r[35]===W?q=r[36]:(q=(0,g.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,g.jsxs)(`div`,{className:W,children:[G,K]})}),r[35]=W,r[36]=q);let J;if(r[37]!==v||r[38]!==x||r[39]!==P||r[40]!==m?.username||r[41]!==i){let e;r[43]!==v||r[44]!==P||r[45]!==m?.username||r[46]!==i?(e=e=>(0,g.jsxs)(`div`,{onClick:()=>P(e),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${v} ${m?.username===e.username?i===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,g.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,g.jsx)(ce,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,g.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,g.jsx)(`div`,{className:`text-sm truncate font-bold`,children:e.username}),(0,g.jsx)(`div`,{className:`text-xs truncate ${i===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},e.username),r[43]=v,r[44]=P,r[45]=m?.username,r[46]=i,r[47]=e):e=r[47],J=x.map(e),r[37]=v,r[38]=x,r[39]=P,r[40]=m?.username,r[41]=i,r[42]=J}else J=r[42];let Y;r[48]===J?Y=r[49]:(Y=(0,g.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:J}),r[48]=J,r[49]=Y);let X;r[50]!==I||r[51]!==U||r[52]!==q||r[53]!==Y?(X=(0,g.jsxs)(`div`,{className:I,children:[U,q,Y]}),r[50]=I,r[51]=U,r[52]=q,r[53]=Y,r[54]=X):X=r[54];let Ce=`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${i===`dark`?`bg-black`:`bg-white`} ${m?`flex`:`hidden md:flex`}`,Z;r[55]!==_||r[56]!==A||r[57]!==E||r[58]!==d||r[59]!==h||r[60]!==m||r[61]!==a||r[62]!==i||r[63]!==c?.id?(Z=m?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${_} shrink-0`,children:[(0,g.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,g.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>d(`/messages`),children:(0,g.jsx)(te,{size:28})}),(0,g.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>d(`/profile/${m.username}`),children:(0,g.jsx)(ce,{src:m.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,g.jsx)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline`,onClick:()=>d(`/profile/${m.username}`),children:m.username})]}),(0,g.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,g.jsx)(de,{size:24,className:`cursor-pointer`}),(0,g.jsx)(oe,{size:24,className:`cursor-pointer`}),(0,g.jsx)(ue,{size:24,className:`cursor-pointer`})]})]}),(0,g.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[E.map((e,t)=>(0,g.jsx)(`div`,{className:`flex gap-2 max-w-[85%] items-end ${e.sender_id===c?.id?`self-end justify-end`:`self-start`}`,children:(0,g.jsx)(g.Fragment,{children:e.content&&(0,g.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${e.sender_id===c?.id?`bg-[#006a4e] text-white`:i===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:e.content})})},e.id||t)),(0,g.jsx)(`div`,{ref:xe})]}),(0,g.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,g.jsxs)(`form`,{className:`border ${_} rounded-full px-2 h-11 flex items-center gap-2 ${i===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),A()},children:[(0,g.jsx)(`div`,{className:`bg-[#006a4e] hover:bg-[#00523c] rounded-full p-2 cursor-pointer ml-1 text-white`,children:(0,g.jsx)(e,{size:16,fill:`currentColor`})}),(0,g.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:h,onChange:e=>be(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${i===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,g.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!h.trim(),children:`পাঠান`})]})})]}):(0,g.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,g.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${i===`dark`?`border-white`:`border-black`}`,children:(0,g.jsx)(le,{size:48,strokeWidth:1})}),(0,g.jsxs)(`div`,{children:[(0,g.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,g.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>a(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]}),r[55]=_,r[56]=A,r[57]=E,r[58]=d,r[59]=h,r[60]=m,r[61]=a,r[62]=i,r[63]=c?.id,r[64]=Z):Z=r[64];let Q;r[65]!==Ce||r[66]!==Z?(Q=(0,g.jsx)(`div`,{className:Ce,children:Z}),r[65]=Ce,r[66]=Z,r[67]=Q):Q=r[67];let $;return r[68]!==F||r[69]!==X||r[70]!==Q?($=(0,g.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,g.jsxs)(`div`,{className:F,children:[X,Q]})}),r[68]=F,r[69]=X,r[70]=Q,r[71]=$):$=r[71],$};export{be as default};