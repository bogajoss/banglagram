import{n as e,t}from"./chevron-down-Cyt6Bwhx.js";import{A as n,D as r,F as i,I as a,L as o,M as s,N as c,P as ee,S as te,_ as ne,d as re,f as ie,i as ae,j as oe,k as l,p as se,s as ce,u,v as le,w as d}from"./index-C-pqn5Gf.js";var ue=d(`info`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`path`,{d:`M12 16v-4`,key:`1dtifu`}],[`path`,{d:`M12 8h.01`,key:`e9boi3`}]]),de=d(`square-pen`,[[`path`,{d:`M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7`,key:`1m0v6g`}],[`path`,{d:`M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z`,key:`ohrbg2`}]]),f=o(a(),1),fe=r();const p=e=>[`messages`,e],pe=(e,t)=>{let r=(0,fe.c)(9),i=t||``,a;r[0]===i?a=r[1]:(a=p(i),r[0]=i,r[1]=a);let o=!!e&&!!t,s;r[2]!==e||r[3]!==t?(s=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await u.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},r[2]=e,r[3]=t,r[4]=s):s=r[4];let c;return r[5]!==a||r[6]!==o||r[7]!==s?(c={queryKey:a,enabled:o,queryFn:s},r[5]=a,r[6]=o,r[7]=s,r[8]=c):c=r[8],n(c)};var me=r();const he=[`conversations`],ge=e=>{let t=(0,me.c)(5),r=!!e,i;t[0]===e?i=t[1]:(i=async()=>{if(!e)return[];let{data:t,error:n}=await u.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,isVerified:n.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=i);let a;return t[2]!==r||t[3]!==i?(a={queryKey:he,enabled:r,queryFn:i},t[2]=r,t[3]=i,t[4]=a):a=t[4],n(a)};var m=r();const _e=()=>{let e=(0,m.c)(2),t=oe(),n;return e[0]===t?n=e[1]:(n={mutationFn:h,onMutate:async e=>{let n=p(e.receiverId);await t.cancelQueries({queryKey:n});let r=t.getQueryData(n);return r&&t.setQueryData(n,[...r,{id:`optimistic-`+Date.now(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content,media_url:null,is_read:!1,created_at:new Date().toISOString()}]),{previousMessages:r}},onError:(e,n,r)=>{r?.previousMessages&&t.setQueryData(p(n.receiverId),r.previousMessages),console.error(e)},onSettled:(e,n,r)=>{t.invalidateQueries({queryKey:p(r.receiverId)}),t.invalidateQueries({queryKey:[`conversations`]})}},e[0]=t,e[1]=n),l(n)};async function h(e){let{content:t,senderId:n,receiverId:r}=e,{data:i,error:a}=await u.from(`messages`).insert({sender_id:n,receiver_id:r,content:t}).select().single();if(a)throw a;return i}var ve=r(),g=s(),ye=()=>{let n=(0,ve.c)(80),{theme:r,showToast:a}=se(),{user:o,profile:s}=ie(),l=oe(),d=ee(),fe=c(),{username:me}=i(),{data:he}=ce(me||``,o?.id),m=fe.state?.user||he?.user||null,[h,ye]=(0,f.useState)(``),be=(0,f.useRef)(null),_=r===`dark`?`border-zinc-800`:`border-zinc-200`,v=r===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`,{data:y}=ge(o?.id),b;n[0]===y?b=n[1]:(b=y===void 0?[]:y,n[0]=y,n[1]=b);let x=b,S;n[2]!==x||n[3]!==m?.id||n[4]!==m?.username?(S=m?.id||x.find(e=>e.username===m?.username)?.id,n[2]=x,n[3]=m?.id,n[4]=m?.username,n[5]=S):S=n[5];let C=S,{data:w}=pe(o?.id,C),T;n[6]===w?T=n[7]:(T=w===void 0?[]:w,n[6]=w,n[7]=T);let E=T,{mutate:xe}=_e(),D,O;n[8]!==l||n[9]!==C||n[10]!==o?(D=()=>{if(!o)return;let e=u.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`INSERT`,schema:`public`,table:`messages`},e=>{let t=e.new;if(t.receiver_id!==o.id&&t.sender_id!==o.id)return;l.invalidateQueries({queryKey:[`conversations`]}),console.log(`Realtime msg:`,t,`Selected:`,C);let n=t.sender_id===C&&t.receiver_id===o.id||t.sender_id===o.id&&t.receiver_id===C;C&&n&&(l.setQueryData(p(C),e=>e&&e.some(e=>e.id===t.id)?e:e?[...e,t]:[t]),l.invalidateQueries({queryKey:p(C)}))}).subscribe();return()=>{u.removeChannel(e)}},O=[o,C,l],n[8]=l,n[9]=C,n[10]=o,n[11]=D,n[12]=O):(D=n[11],O=n[12]),(0,f.useEffect)(D,O);let k;n[13]!==h||n[14]!==m||n[15]!==C||n[16]!==xe||n[17]!==o?(k=()=>{if(console.log(`Attempting to send message:`,h,C,o?.id,m),!h.trim()||!C||!o){console.warn(`Send aborted: Missing data`,{msg:h,target:C,user:o?.id,selectedObject:m});return}xe({content:h,senderId:o.id,receiverId:C}),ye(``)},n[13]=h,n[14]=m,n[15]=C,n[16]=xe,n[17]=o,n[18]=k):k=n[18];let A=k,j;n[19]===Symbol.for(`react.memo_cache_sentinel`)?(j=()=>{be.current?.scrollIntoView({behavior:`smooth`})},n[19]=j):j=n[19];let M;n[20]===E?M=n[21]:(M=[E],n[20]=E,n[21]=M),(0,f.useEffect)(j,M);let N;n[22]===d?N=n[23]:(N=e=>{d(`/messages/${e.username}`,{state:{user:e}})},n[22]=d,n[23]=N);let P=N,F=`w-full h-full md:border ${_} rounded-lg flex overflow-hidden relative shadow-lg`,Se=`w-full md:w-[397px] border-r ${_} flex flex-col absolute md:relative inset-0 z-10 ${r===`dark`?`bg-black`:`bg-white`} ${m?`hidden md:flex`:`flex`}`,Ce=`h-[75px] px-5 flex items-center justify-between border-b ${_} shrink-0`,I;n[24]===d?I=n[25]:(I=()=>d(`/`),n[24]=d,n[25]=I);let L;n[26]===Symbol.for(`react.memo_cache_sentinel`)?(L=(0,g.jsx)(te,{size:28}),n[26]=L):L=n[26];let R;n[27]===I?R=n[28]:(R=(0,g.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-1`,onClick:I,children:L}),n[27]=I,n[28]=R);let we=s?.username,z;n[29]===we?z=n[30]:(z=(0,g.jsx)(`span`,{className:`font-bold text-xl`,children:we}),n[29]=we,n[30]=z);let B;n[31]===Symbol.for(`react.memo_cache_sentinel`)?(B=(0,g.jsx)(t,{size:20}),n[31]=B):B=n[31];let V;n[32]===z?V=n[33]:(V=(0,g.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[z,B]}),n[32]=z,n[33]=V);let H;n[34]!==R||n[35]!==V?(H=(0,g.jsxs)(`div`,{className:`flex items-center gap-2`,children:[R,V]}),n[34]=R,n[35]=V,n[36]=H):H=n[36];let U;n[37]===Symbol.for(`react.memo_cache_sentinel`)?(U=(0,g.jsx)(de,{size:24,className:`cursor-pointer`}),n[37]=U):U=n[37];let W;n[38]!==Ce||n[39]!==H?(W=(0,g.jsxs)(`div`,{className:Ce,children:[H,U]}),n[38]=Ce,n[39]=H,n[40]=W):W=n[40];let Te=`flex items-center gap-2 px-3 py-2 rounded-lg ${r===`dark`?`bg-[#262626]`:`bg-gray-100`}`,G,K;n[41]===Symbol.for(`react.memo_cache_sentinel`)?(G=(0,g.jsx)(ne,{size:16,className:`text-[#8e8e8e]`}),K=(0,g.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),n[41]=G,n[42]=K):(G=n[41],K=n[42]);let q;n[43]===Te?q=n[44]:(q=(0,g.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,g.jsxs)(`div`,{className:Te,children:[G,K]})}),n[43]=Te,n[44]=q);let J;if(n[45]!==v||n[46]!==x||n[47]!==P||n[48]!==m?.username||n[49]!==r){let e;n[51]!==v||n[52]!==P||n[53]!==m?.username||n[54]!==r?(e=e=>(0,g.jsxs)(`div`,{onClick:()=>P(e),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${v} ${m?.username===e.username?r===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,g.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,g.jsx)(re,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,g.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,g.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,g.jsx)(ae,{})]}),(0,g.jsx)(`div`,{className:`text-xs truncate ${r===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},e.username),n[51]=v,n[52]=P,n[53]=m?.username,n[54]=r,n[55]=e):e=n[55],J=x.map(e),n[45]=v,n[46]=x,n[47]=P,n[48]=m?.username,n[49]=r,n[50]=J}else J=n[50];let Y;n[56]===J?Y=n[57]:(Y=(0,g.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:J}),n[56]=J,n[57]=Y);let X;n[58]!==Se||n[59]!==W||n[60]!==q||n[61]!==Y?(X=(0,g.jsxs)(`div`,{className:Se,children:[W,q,Y]}),n[58]=Se,n[59]=W,n[60]=q,n[61]=Y,n[62]=X):X=n[62];let Ee=`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${r===`dark`?`bg-black`:`bg-white`} ${m?`flex`:`hidden md:flex`}`,Z;n[63]!==_||n[64]!==A||n[65]!==E||n[66]!==d||n[67]!==h||n[68]!==m||n[69]!==a||n[70]!==r||n[71]!==o?.id?(Z=m?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${_} shrink-0`,children:[(0,g.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,g.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>d(`/messages`),children:(0,g.jsx)(te,{size:28})}),(0,g.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>d(`/profile/${m.username}`),children:(0,g.jsx)(re,{src:m.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,g.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>d(`/profile/${m.username}`),children:[m.username,m.isVerified&&(0,g.jsx)(ae,{})]})]}),(0,g.jsx)(`div`,{className:`flex items-center gap-4`,children:(0,g.jsx)(ue,{size:24,className:`cursor-pointer`})})]}),(0,g.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[E.map((e,t)=>(0,g.jsx)(`div`,{className:`flex gap-2 max-w-[85%] items-end ${e.sender_id===o?.id?`self-end justify-end`:`self-start`}`,children:(0,g.jsx)(g.Fragment,{children:e.content&&(0,g.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${e.sender_id===o?.id?`bg-[#006a4e] text-white`:r===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:e.content})})},e.id||t)),(0,g.jsx)(`div`,{ref:be})]}),(0,g.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,g.jsxs)(`form`,{className:`border ${_} rounded-full px-2 h-11 flex items-center gap-2 ${r===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),A()},children:[(0,g.jsx)(`div`,{className:`bg-[#006a4e] hover:bg-[#00523c] rounded-full p-2 cursor-pointer ml-1 text-white`,children:(0,g.jsx)(e,{size:16,fill:`currentColor`})}),(0,g.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:h,onChange:e=>ye(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${r===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,g.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!h.trim(),children:`পাঠান`})]})})]}):(0,g.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,g.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${r===`dark`?`border-white`:`border-black`}`,children:(0,g.jsx)(le,{size:48,strokeWidth:1})}),(0,g.jsxs)(`div`,{children:[(0,g.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,g.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>a(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]}),n[63]=_,n[64]=A,n[65]=E,n[66]=d,n[67]=h,n[68]=m,n[69]=a,n[70]=r,n[71]=o?.id,n[72]=Z):Z=n[72];let Q;n[73]!==Ee||n[74]!==Z?(Q=(0,g.jsx)(`div`,{className:Ee,children:Z}),n[73]=Ee,n[74]=Z,n[75]=Q):Q=n[75];let $;return n[76]!==F||n[77]!==X||n[78]!==Q?($=(0,g.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,g.jsxs)(`div`,{className:F,children:[X,Q]})}),n[76]=F,n[77]=X,n[78]=Q,n[79]=$):$=n[79],$};export{ye as default};