import{a as e}from"./rolldown-runtime-Cn8xt2Gj.js";import{At as t,Dt as n,Gt as r,Ht as i,K as a,N as o,Nt as s,Pt as ee,Ut as te,V as ne,Vt as re,_t as ie,et as ae,jt as c,st as oe,vt as se,yt as ce}from"./vendor-j4eAkL9f.js";import{tn as l}from"./libs-Bghk4o3g.js";import"./tanstack-DEYdLxKO.js";import"./supabase-nYr-R5G6.js";import{_ as le,g as ue,i as de,p as u,u as fe,v as pe}from"./index-BnmHHGy6.js";var d=e(r(),1),me=n();const f=e=>[`messages`,e],he=(e,t)=>{let n=(0,me.c)(9),r=t||``,i;n[0]===r?i=n[1]:(i=f(r),n[0]=r,n[1]=i);let a=!!e&&!!t,o;n[2]!==e||n[3]!==t?(o=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await u.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},n[2]=e,n[3]=t,n[4]=o):o=n[4];let s;return n[5]!==i||n[6]!==a||n[7]!==o?(s={queryKey:i,enabled:a,queryFn:o},n[5]=i,n[6]=a,n[7]=o,n[8]=s):s=n[8],c(s)};var ge=n();const _e=[`conversations`],ve=e=>{let t=(0,ge.c)(5),n=!!e,r;t[0]===e?r=t[1]:(r=async()=>{if(!e)return[];let{data:t,error:n}=await u.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,isVerified:n.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=r);let i;return t[2]!==n||t[3]!==r?(i={queryKey:_e,enabled:n,queryFn:r},t[2]=n,t[3]=r,t[4]=i):i=t[4],c(i)};var p=n(),m=e(l(),1);const ye=()=>{let e=(0,p.c)(2),n=s(),r;return e[0]===n?r=e[1]:(r={mutationFn:be,onMutate:async e=>{let t=f(e.receiverId);await n.cancelQueries({queryKey:t});let r=n.getQueryData(t);return r&&n.setQueryData(t,[...r,{id:`optimistic-`+(0,m.default)().valueOf(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content,media_url:null,is_read:!1,created_at:(0,m.default)().toISOString()}]),{previousMessages:r}},onError:(e,t,r)=>{r?.previousMessages&&n.setQueryData(f(t.receiverId),r.previousMessages),console.error(e)},onSettled:(e,t,r)=>{n.invalidateQueries({queryKey:f(r.receiverId)}),n.invalidateQueries({queryKey:[`conversations`]})}},e[0]=n,e[1]=r),t(r)};async function be(e){let{content:t,senderId:n,receiverId:r}=e,{data:i,error:a}=await u.from(`messages`).insert({sender_id:n,receiver_id:r,content:t}).select().single();if(a)throw a;return i}var xe=n(),h=ee(),g=()=>{let e=(0,xe.c)(87),{theme:t,showToast:n}=pe(),{user:r,profile:ee}=le(),c=s(),l=i(),me=re(),{username:ge}=te(),{data:_e}=fe(ge||``,r?.id),p=me.state?.user||_e?.user||null,[m,be]=(0,d.useState)(``),[g,Ce]=(0,d.useState)(``),_;e[0]===Symbol.for(`react.memo_cache_sentinel`)?(_=[],e[0]=_):_=e[0];let[v,we]=(0,d.useState)(_),[Te,Ee]=(0,d.useState)(!1),De=(0,d.useRef)(null),y=t===`dark`?`border-zinc-800`:`border-zinc-200`,b=t===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`,x,S;e[1]===g?(x=e[2],S=e[3]):(x=()=>{let e=setTimeout(async()=>{if(g.trim().length>0){Ee(!0);let{data:e}=await u.from(`profiles`).select(`id, username, full_name, avatar_url, is_verified`).ilike(`username`,`%${g}%`).limit(10);e&&we(e.map(Se)),Ee(!1)}else we([])},300);return()=>clearTimeout(e)},S=[g],e[1]=g,e[2]=x,e[3]=S),(0,d.useEffect)(x,S);let{data:C}=ve(r?.id),w;e[4]===C?w=e[5]:(w=C===void 0?[]:C,e[4]=C,e[5]=w);let T=w,E;e[6]!==T||e[7]!==p?.id||e[8]!==p?.username?(E=p?.id||T.find(e=>e.username===p?.username)?.id,e[6]=T,e[7]=p?.id,e[8]=p?.username,e[9]=E):E=e[9];let D=E,{data:O}=he(r?.id,D),k;e[10]===O?k=e[11]:(k=O===void 0?[]:O,e[10]=O,e[11]=k);let A=k,{mutate:Oe}=ye(),j,M;e[12]!==c||e[13]!==D||e[14]!==r?(j=()=>{if(!r)return;let e=u.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`INSERT`,schema:`public`,table:`messages`},e=>{let t=e.new;if(t.receiver_id!==r.id&&t.sender_id!==r.id)return;c.invalidateQueries({queryKey:[`conversations`]}),console.log(`Realtime msg:`,t,`Selected:`,D);let n=t.sender_id===D&&t.receiver_id===r.id||t.sender_id===r.id&&t.receiver_id===D;D&&n&&(c.setQueryData(f(D),e=>e&&e.some(e=>e.id===t.id)?e:e?[...e,t]:[t]),c.invalidateQueries({queryKey:f(D)}))}).subscribe();return()=>{u.removeChannel(e)}},M=[r,D,c],e[12]=c,e[13]=D,e[14]=r,e[15]=j,e[16]=M):(j=e[15],M=e[16]),(0,d.useEffect)(j,M);let N;e[17]!==m||e[18]!==p||e[19]!==D||e[20]!==Oe||e[21]!==r?(N=()=>{if(console.log(`Attempting to send message:`,m,D,r?.id,p),!m.trim()||!D||!r){console.warn(`Send aborted: Missing data`,{msg:m,target:D,user:r?.id,selectedObject:p});return}Oe({content:m,senderId:r.id,receiverId:D}),be(``)},e[17]=m,e[18]=p,e[19]=D,e[20]=Oe,e[21]=r,e[22]=N):N=e[22];let ke=N,P;e[23]===Symbol.for(`react.memo_cache_sentinel`)?(P=()=>{De.current?.scrollIntoView({behavior:`smooth`})},e[23]=P):P=e[23];let F;e[24]===A?F=e[25]:(F=[A],e[24]=A,e[25]=F),(0,d.useEffect)(P,F);let I;e[26]===l?I=e[27]:(I=e=>{l(`/messages/${e.username}`,{state:{user:e}})},e[26]=l,e[27]=I);let L=I,Ae=`w-full h-full md:border ${y} rounded-lg flex overflow-hidden relative shadow-lg`,je=`w-full md:w-[397px] border-r ${y} flex flex-col absolute md:relative inset-0 z-10 ${t===`dark`?`bg-black`:`bg-white`} ${p?`hidden md:flex`:`flex`}`,Me=`h-[75px] px-5 flex items-center justify-between border-b ${y} shrink-0`,R;e[28]===l?R=e[29]:(R=()=>l(`/`),e[28]=l,e[29]=R);let z;e[30]===Symbol.for(`react.memo_cache_sentinel`)?(z=(0,h.jsx)(ie,{size:28}),e[30]=z):z=e[30];let B;e[31]===R?B=e[32]:(B=(0,h.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-1`,onClick:R,children:z}),e[31]=R,e[32]=B);let Ne=ee?.username,V;e[33]===Ne?V=e[34]:(V=(0,h.jsx)(`span`,{className:`font-bold text-xl`,children:Ne}),e[33]=Ne,e[34]=V);let Pe;e[35]===Symbol.for(`react.memo_cache_sentinel`)?(Pe=(0,h.jsx)(se,{size:20}),e[35]=Pe):Pe=e[35];let H;e[36]===V?H=e[37]:(H=(0,h.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[V,Pe]}),e[36]=V,e[37]=H);let U;e[38]!==B||e[39]!==H?(U=(0,h.jsxs)(`div`,{className:`flex items-center gap-2`,children:[B,H]}),e[38]=B,e[39]=H,e[40]=U):U=e[40];let Fe;e[41]===Symbol.for(`react.memo_cache_sentinel`)?(Fe=(0,h.jsx)(ne,{size:24,className:`cursor-pointer`}),e[41]=Fe):Fe=e[41];let W;e[42]!==Me||e[43]!==U?(W=(0,h.jsxs)(`div`,{className:Me,children:[U,Fe]}),e[42]=Me,e[43]=U,e[44]=W):W=e[44];let Ie=`flex items-center gap-2 px-3 py-2 rounded-lg ${t===`dark`?`bg-[#262626]`:`bg-gray-100`}`,Le;e[45]===Symbol.for(`react.memo_cache_sentinel`)?(Le=(0,h.jsx)(a,{size:16,className:`text-[#8e8e8e]`}),e[45]=Le):Le=e[45];let G;e[46]===Symbol.for(`react.memo_cache_sentinel`)?(G=e=>Ce(e.target.value),e[46]=G):G=e[46];let K,q;e[47]===g?(K=e[48],q=e[49]):(K=(0,h.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,value:g,onChange:G,className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),q=g&&(0,h.jsx)(o,{size:16,className:`cursor-pointer text-[#8e8e8e]`,onClick:()=>Ce(``)}),e[47]=g,e[48]=K,e[49]=q);let J;e[50]!==Ie||e[51]!==K||e[52]!==q?(J=(0,h.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,h.jsxs)(`div`,{className:Ie,children:[Le,K,q]})}),e[50]=Ie,e[51]=K,e[52]=q,e[53]=J):J=e[53];let Y;e[54]!==b||e[55]!==T||e[56]!==L||e[57]!==Te||e[58]!==g||e[59]!==v||e[60]!==p?.username||e[61]!==t?(Y=g?(0,h.jsx)(h.Fragment,{children:Te?(0,h.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`অনুসন্ধান করা হচ্ছে...`}):v.length===0?(0,h.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`কোনো ফলাফল পাওয়া যায়নি`}):v.map(e=>(0,h.jsxs)(`div`,{onClick:()=>{L(e),Ce(``)},className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${b}`,children:[(0,h.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,h.jsx)(ue,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,h.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,h.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,h.jsx)(de,{})]}),(0,h.jsx)(`div`,{className:`text-xs truncate ${t===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:e.name})]})]},e.username))}):T.map(e=>(0,h.jsxs)(`div`,{onClick:()=>L(e),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${b} ${p?.username===e.username?t===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,h.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,h.jsx)(ue,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,h.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,h.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,h.jsx)(de,{})]}),(0,h.jsx)(`div`,{className:`text-xs truncate ${t===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},e.username)),e[54]=b,e[55]=T,e[56]=L,e[57]=Te,e[58]=g,e[59]=v,e[60]=p?.username,e[61]=t,e[62]=Y):Y=e[62];let X;e[63]===Y?X=e[64]:(X=(0,h.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:Y}),e[63]=Y,e[64]=X);let Z;e[65]!==je||e[66]!==W||e[67]!==J||e[68]!==X?(Z=(0,h.jsxs)(`div`,{className:je,children:[W,J,X]}),e[65]=je,e[66]=W,e[67]=J,e[68]=X,e[69]=Z):Z=e[69];let Re=`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${t===`dark`?`bg-black`:`bg-white`} ${p?`flex`:`hidden md:flex`}`,Q;e[70]!==y||e[71]!==ke||e[72]!==A||e[73]!==l||e[74]!==m||e[75]!==p||e[76]!==n||e[77]!==t||e[78]!==r?.id?(Q=p?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${y} shrink-0`,children:[(0,h.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,h.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>l(`/messages`),children:(0,h.jsx)(ie,{size:28})}),(0,h.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>l(`/profile/${p.username}`),children:(0,h.jsx)(ue,{src:p.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,h.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>l(`/profile/${p.username}`),children:[p.username,p.isVerified&&(0,h.jsx)(de,{})]})]}),(0,h.jsx)(`div`,{className:`flex items-center gap-4`,children:(0,h.jsx)(oe,{size:24,className:`cursor-pointer`})})]}),(0,h.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[A.map((e,n)=>(0,h.jsx)(`div`,{className:`flex gap-2 max-w-[85%] items-end ${e.sender_id===r?.id?`self-end justify-end`:`self-start`}`,children:(0,h.jsx)(h.Fragment,{children:e.content&&(0,h.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${e.sender_id===r?.id?`bg-[#006a4e] text-white`:t===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:e.content})})},e.id||n)),(0,h.jsx)(`div`,{ref:De})]}),(0,h.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,h.jsxs)(`form`,{className:`border ${y} rounded-full px-2 h-11 flex items-center gap-2 ${t===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),ke()},children:[(0,h.jsx)(`div`,{className:`bg-[#006a4e] hover:bg-[#00523c] rounded-full p-2 cursor-pointer ml-1 text-white`,children:(0,h.jsx)(ce,{size:16,fill:`currentColor`})}),(0,h.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:m,onChange:e=>be(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${t===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,h.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!m.trim(),children:`পাঠান`})]})})]}):(0,h.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,h.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${t===`dark`?`border-white`:`border-black`}`,children:(0,h.jsx)(ae,{size:48,strokeWidth:1})}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,h.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>n(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]}),e[70]=y,e[71]=ke,e[72]=A,e[73]=l,e[74]=m,e[75]=p,e[76]=n,e[77]=t,e[78]=r?.id,e[79]=Q):Q=e[79];let $;e[80]!==Re||e[81]!==Q?($=(0,h.jsx)(`div`,{className:Re,children:Q}),e[80]=Re,e[81]=Q,e[82]=$):$=e[82];let ze;return e[83]!==Ae||e[84]!==Z||e[85]!==$?(ze=(0,h.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,h.jsxs)(`div`,{className:Ae,children:[Z,$]})}),e[83]=Ae,e[84]=Z,e[85]=$,e[86]=ze):ze=e[86],ze};function Se(e){return{id:e.id,username:e.username,name:e.full_name||e.username,avatar:e.avatar_url||``,isVerified:e.is_verified||!1}}export{g as default};