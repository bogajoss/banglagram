import{n as e,t}from"./chevron-down-DXGpoZe6.js";import{A as n,C as r,F as i,I as a,L as o,M as s,N as c,O as l,P as ee,T as u,d as te,f as ne,h as re,i as ie,j as ae,k as d,p as oe,s as se,u as f,v as ce,y as le}from"./index-D58btYjJ.js";var ue=u(`info`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`path`,{d:`M12 16v-4`,key:`1dtifu`}],[`path`,{d:`M12 8h.01`,key:`e9boi3`}]]),de=u(`phone`,[[`path`,{d:`M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384`,key:`9njp5v`}]]),fe=u(`square-pen`,[[`path`,{d:`M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7`,key:`1m0v6g`}],[`path`,{d:`M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z`,key:`ohrbg2`}]]),p=o(a(),1),pe=l();const m=e=>[`messages`,e],me=(e,t)=>{let r=(0,pe.c)(9),i=t||``,a;r[0]===i?a=r[1]:(a=m(i),r[0]=i,r[1]=a);let o=!!e&&!!t,s;r[2]!==e||r[3]!==t?(s=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await f.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},r[2]=e,r[3]=t,r[4]=s):s=r[4];let c;return r[5]!==a||r[6]!==o||r[7]!==s?(c={queryKey:a,enabled:o,queryFn:s},r[5]=a,r[6]=o,r[7]=s,r[8]=c):c=r[8],n(c)};var he=l();const ge=[`conversations`],_e=e=>{let t=(0,he.c)(5),r=!!e,i;t[0]===e?i=t[1]:(i=async()=>{if(!e)return[];let{data:t,error:n}=await f.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,isVerified:n.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=i);let a;return t[2]!==r||t[3]!==i?(a={queryKey:ge,enabled:r,queryFn:i},t[2]=r,t[3]=i,t[4]=a):a=t[4],n(a)};var h=l();const ve=()=>{let e=(0,h.c)(2),t=ae(),n;return e[0]===t?n=e[1]:(n={mutationFn:g,onMutate:async e=>{let n=m(e.receiverId);await t.cancelQueries({queryKey:n});let r=t.getQueryData(n);return r&&t.setQueryData(n,[...r,{id:`optimistic-`+Date.now(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content,media_url:null,is_read:!1,created_at:new Date().toISOString()}]),{previousMessages:r}},onError:(e,n,r)=>{r?.previousMessages&&t.setQueryData(m(n.receiverId),r.previousMessages),console.error(e)},onSettled:(e,n,r)=>{t.invalidateQueries({queryKey:m(r.receiverId)}),t.invalidateQueries({queryKey:[`conversations`]})}},e[0]=t,e[1]=n),d(n)};async function g(e){let{content:t,senderId:n,receiverId:r}=e,{data:i,error:a}=await f.from(`messages`).insert({sender_id:n,receiver_id:r,content:t}).select().single();if(a)throw a;return i}var ye=l(),_=s(),be=()=>{let n=(0,ye.c)(72),{theme:a,showToast:o}=oe(),{user:s,profile:l}=ne(),u=ae(),d=ee(),pe=c(),{username:he}=i(),{data:ge}=se(he||``,s?.id),h=pe.state?.user||ge?.user||null,[g,be]=(0,p.useState)(``),xe=(0,p.useRef)(null),v=a===`dark`?`border-zinc-800`:`border-zinc-200`,y=a===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`,{data:b}=_e(s?.id),x;n[0]===b?x=n[1]:(x=b===void 0?[]:b,n[0]=b,n[1]=x);let S=x,C;n[2]!==S||n[3]!==h?.id||n[4]!==h?.username?(C=h?.id||S.find(e=>e.username===h?.username)?.id,n[2]=S,n[3]=h?.id,n[4]=h?.username,n[5]=C):C=n[5];let w=C,{data:T}=me(s?.id,w),E;n[6]===T?E=n[7]:(E=T===void 0?[]:T,n[6]=T,n[7]=E);let D=E,{mutate:Se}=ve(),O,k;n[8]!==u||n[9]!==w||n[10]!==s?(O=()=>{if(!s)return;let e=f.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`INSERT`,schema:`public`,table:`messages`},e=>{let t=e.new;if(t.receiver_id!==s.id&&t.sender_id!==s.id)return;u.invalidateQueries({queryKey:[`conversations`]}),console.log(`Realtime msg:`,t,`Selected:`,w);let n=t.sender_id===w&&t.receiver_id===s.id||t.sender_id===s.id&&t.receiver_id===w;w&&n&&(u.setQueryData(m(w),e=>e&&e.some(e=>e.id===t.id)?e:e?[...e,t]:[t]),u.invalidateQueries({queryKey:m(w)}))}).subscribe();return()=>{f.removeChannel(e)}},k=[s,w,u],n[8]=u,n[9]=w,n[10]=s,n[11]=O,n[12]=k):(O=n[11],k=n[12]),(0,p.useEffect)(O,k);let A;n[13]!==g||n[14]!==h||n[15]!==w||n[16]!==Se||n[17]!==s?(A=()=>{if(console.log(`Attempting to send message:`,g,w,s?.id,h),!g.trim()||!w||!s){console.warn(`Send aborted: Missing data`,{msg:g,target:w,user:s?.id,selectedObject:h});return}Se({content:g,senderId:s.id,receiverId:w}),be(``)},n[13]=g,n[14]=h,n[15]=w,n[16]=Se,n[17]=s,n[18]=A):A=n[18];let j=A,M;n[19]===Symbol.for(`react.memo_cache_sentinel`)?(M=()=>{xe.current?.scrollIntoView({behavior:`smooth`})},n[19]=M):M=n[19];let N;n[20]===D?N=n[21]:(N=[D],n[20]=D,n[21]=N),(0,p.useEffect)(M,N);let P;n[22]===d?P=n[23]:(P=e=>{d(`/messages/${e.username}`,{state:{user:e}})},n[22]=d,n[23]=P);let F=P,I=`w-full h-full md:border ${v} rounded-lg flex overflow-hidden relative shadow-lg`,L=`w-full md:w-[397px] border-r ${v} flex flex-col absolute md:relative inset-0 z-10 ${a===`dark`?`bg-black`:`bg-white`} ${h?`hidden md:flex`:`flex`}`,R=`h-[75px] px-5 flex items-center justify-between border-b ${v} shrink-0`,Ce=l?.username,z;n[24]===Ce?z=n[25]:(z=(0,_.jsx)(`span`,{className:`font-bold text-xl`,children:Ce}),n[24]=Ce,n[25]=z);let B;n[26]===Symbol.for(`react.memo_cache_sentinel`)?(B=(0,_.jsx)(t,{size:20}),n[26]=B):B=n[26];let V;n[27]===z?V=n[28]:(V=(0,_.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[z,B]}),n[27]=z,n[28]=V);let H;n[29]===Symbol.for(`react.memo_cache_sentinel`)?(H=(0,_.jsx)(fe,{size:24,className:`cursor-pointer`}),n[29]=H):H=n[29];let U;n[30]!==R||n[31]!==V?(U=(0,_.jsxs)(`div`,{className:R,children:[V,H]}),n[30]=R,n[31]=V,n[32]=U):U=n[32];let W=`flex items-center gap-2 px-3 py-2 rounded-lg ${a===`dark`?`bg-[#262626]`:`bg-gray-100`}`,G,K;n[33]===Symbol.for(`react.memo_cache_sentinel`)?(G=(0,_.jsx)(ce,{size:16,className:`text-[#8e8e8e]`}),K=(0,_.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),n[33]=G,n[34]=K):(G=n[33],K=n[34]);let q;n[35]===W?q=n[36]:(q=(0,_.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,_.jsxs)(`div`,{className:W,children:[G,K]})}),n[35]=W,n[36]=q);let J;if(n[37]!==y||n[38]!==S||n[39]!==F||n[40]!==h?.username||n[41]!==a){let e;n[43]!==y||n[44]!==F||n[45]!==h?.username||n[46]!==a?(e=e=>(0,_.jsxs)(`div`,{onClick:()=>F(e),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${y} ${h?.username===e.username?a===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,_.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,_.jsx)(te,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,_.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,_.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,_.jsx)(ie,{})]}),(0,_.jsx)(`div`,{className:`text-xs truncate ${a===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},e.username),n[43]=y,n[44]=F,n[45]=h?.username,n[46]=a,n[47]=e):e=n[47],J=S.map(e),n[37]=y,n[38]=S,n[39]=F,n[40]=h?.username,n[41]=a,n[42]=J}else J=n[42];let Y;n[48]===J?Y=n[49]:(Y=(0,_.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:J}),n[48]=J,n[49]=Y);let X;n[50]!==L||n[51]!==U||n[52]!==q||n[53]!==Y?(X=(0,_.jsxs)(`div`,{className:L,children:[U,q,Y]}),n[50]=L,n[51]=U,n[52]=q,n[53]=Y,n[54]=X):X=n[54];let we=`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${a===`dark`?`bg-black`:`bg-white`} ${h?`flex`:`hidden md:flex`}`,Z;n[55]!==v||n[56]!==j||n[57]!==D||n[58]!==d||n[59]!==g||n[60]!==h||n[61]!==o||n[62]!==a||n[63]!==s?.id?(Z=h?(0,_.jsxs)(_.Fragment,{children:[(0,_.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${v} shrink-0`,children:[(0,_.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,_.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>d(`/messages`),children:(0,_.jsx)(r,{size:28})}),(0,_.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>d(`/profile/${h.username}`),children:(0,_.jsx)(te,{src:h.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,_.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>d(`/profile/${h.username}`),children:[h.username,h.isVerified&&(0,_.jsx)(ie,{})]})]}),(0,_.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,_.jsx)(de,{size:24,className:`cursor-pointer`}),(0,_.jsx)(re,{size:24,className:`cursor-pointer`}),(0,_.jsx)(ue,{size:24,className:`cursor-pointer`})]})]}),(0,_.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[D.map((e,t)=>(0,_.jsx)(`div`,{className:`flex gap-2 max-w-[85%] items-end ${e.sender_id===s?.id?`self-end justify-end`:`self-start`}`,children:(0,_.jsx)(_.Fragment,{children:e.content&&(0,_.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${e.sender_id===s?.id?`bg-[#006a4e] text-white`:a===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:e.content})})},e.id||t)),(0,_.jsx)(`div`,{ref:xe})]}),(0,_.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,_.jsxs)(`form`,{className:`border ${v} rounded-full px-2 h-11 flex items-center gap-2 ${a===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),j()},children:[(0,_.jsx)(`div`,{className:`bg-[#006a4e] hover:bg-[#00523c] rounded-full p-2 cursor-pointer ml-1 text-white`,children:(0,_.jsx)(e,{size:16,fill:`currentColor`})}),(0,_.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:g,onChange:e=>be(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${a===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,_.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!g.trim(),children:`পাঠান`})]})})]}):(0,_.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,_.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${a===`dark`?`border-white`:`border-black`}`,children:(0,_.jsx)(le,{size:48,strokeWidth:1})}),(0,_.jsxs)(`div`,{children:[(0,_.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,_.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>o(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]}),n[55]=v,n[56]=j,n[57]=D,n[58]=d,n[59]=g,n[60]=h,n[61]=o,n[62]=a,n[63]=s?.id,n[64]=Z):Z=n[64];let Q;n[65]!==we||n[66]!==Z?(Q=(0,_.jsx)(`div`,{className:we,children:Z}),n[65]=we,n[66]=Z,n[67]=Q):Q=n[67];let $;return n[68]!==I||n[69]!==X||n[70]!==Q?($=(0,_.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,_.jsxs)(`div`,{className:I,children:[X,Q]})}),n[68]=I,n[69]=X,n[70]=Q,n[71]=$):$=n[71],$};export{be as default};