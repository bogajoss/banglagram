import{a as e}from"./rolldown-runtime-Cn8xt2Gj.js";import{$ as t,L as n,O as r,R as i,S as a,X as o,Z as s,ct as c,et as l,ft as ee,h as te,lt as ne,q as u,r as re,st as ie,u as ae,z as oe}from"./vendor-DiY0OKC1.js";import"./libs-zsV6iK65.js";import"./tanstack-DEYdLxKO.js";import"./supabase-DbljJtCh.js";import{d as se,f as ce,i as le,p as ue,s as de,u as d}from"./index-DaEsvuEM.js";var f=e(ee(),1),p=u();const m=e=>[`messages`,e],fe=(e,t)=>{let n=(0,p.c)(9),r=t||``,i;n[0]===r?i=n[1]:(i=m(r),n[0]=r,n[1]=i);let a=!!e&&!!t,o;n[2]!==e||n[3]!==t?(o=async()=>{if(!e||!t)throw Error(`IDs required`);let{data:n,error:r}=await d.from(`messages`).select(`*`).or(`and(sender_id.eq.${e},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${e})`).order(`created_at`,{ascending:!0});if(r)throw r;return n},n[2]=e,n[3]=t,n[4]=o):o=n[4];let c;return n[5]!==i||n[6]!==a||n[7]!==o?(c={queryKey:i,enabled:a,queryFn:o},n[5]=i,n[6]=a,n[7]=o,n[8]=c):c=n[8],s(c)};var pe=u();const me=[`conversations`],he=e=>{let t=(0,pe.c)(5),n=!!e,r;t[0]===e?r=t[1]:(r=async()=>{if(!e)return[];let{data:t,error:n}=await d.from(`messages`).select(`
                  sender_id,
                  receiver_id,
                  created_at,
                  sender:profiles!sender_id(id, username, full_name, avatar_url, is_verified),
                  receiver:profiles!receiver_id(id, username, full_name, avatar_url, is_verified)
                `).or(`sender_id.eq.${e},receiver_id.eq.${e}`).order(`created_at`,{ascending:!1});if(n)throw console.error(`Error fetching conversations`,n),n;let r=new Map;return t.forEach(t=>{let n=t.sender_id===e?t.receiver:t.sender;n&&!r.has(n.username)&&r.set(n.username,{id:n.id,username:n.username,name:n.full_name||n.username,avatar:n.avatar_url||``,isVerified:n.is_verified||!1,stats:{posts:0,followers:0,following:0}})}),Array.from(r.values())},t[0]=e,t[1]=r);let i;return t[2]!==n||t[3]!==r?(i={queryKey:me,enabled:n,queryFn:r},t[2]=n,t[3]=r,t[4]=i):i=t[4],s(i)};var ge=u();const _e=()=>{let e=(0,ge.c)(2),n=t(),r;return e[0]===n?r=e[1]:(r={mutationFn:h,onMutate:async e=>{let t=m(e.receiverId);await n.cancelQueries({queryKey:t});let r=n.getQueryData(t);return r&&n.setQueryData(t,[...r,{id:`optimistic-`+Date.now(),sender_id:e.senderId,receiver_id:e.receiverId,content:e.content,media_url:null,is_read:!1,created_at:new Date().toISOString()}]),{previousMessages:r}},onError:(e,t,r)=>{r?.previousMessages&&n.setQueryData(m(t.receiverId),r.previousMessages),console.error(e)},onSettled:(e,t,r)=>{n.invalidateQueries({queryKey:m(r.receiverId)}),n.invalidateQueries({queryKey:[`conversations`]})}},e[0]=n,e[1]=r),o(r)};async function h(e){let{content:t,senderId:n,receiverId:r}=e,{data:i,error:a}=await d.from(`messages`).insert({sender_id:n,receiver_id:r,content:t}).select().single();if(a)throw a;return i}var ve=u(),g=l(),_=()=>{let e=(0,ve.c)(87),{theme:o,showToast:s}=ue(),{user:l,profile:ee}=ce(),u=t(),p=c(),pe=ie(),{username:me}=ne(),{data:ge}=de(me||``,l?.id),h=pe.state?.user||ge?.user||null,[_,be]=(0,f.useState)(``),[v,xe]=(0,f.useState)(``),y;e[0]===Symbol.for(`react.memo_cache_sentinel`)?(y=[],e[0]=y):y=e[0];let[b,Se]=(0,f.useState)(y),[Ce,we]=(0,f.useState)(!1),Te=(0,f.useRef)(null),x=o===`dark`?`border-zinc-800`:`border-zinc-200`,S=o===`dark`?`hover:bg-zinc-900`:`hover:bg-gray-100`,C,w;e[1]===v?(C=e[2],w=e[3]):(C=()=>{let e=setTimeout(async()=>{if(v.trim().length>0){we(!0);let{data:e}=await d.from(`profiles`).select(`id, username, full_name, avatar_url, is_verified`).ilike(`username`,`%${v}%`).limit(10);e&&Se(e.map(ye)),we(!1)}else Se([])},300);return()=>clearTimeout(e)},w=[v],e[1]=v,e[2]=C,e[3]=w),(0,f.useEffect)(C,w);let{data:T}=he(l?.id),E;e[4]===T?E=e[5]:(E=T===void 0?[]:T,e[4]=T,e[5]=E);let D=E,O;e[6]!==D||e[7]!==h?.id||e[8]!==h?.username?(O=h?.id||D.find(e=>e.username===h?.username)?.id,e[6]=D,e[7]=h?.id,e[8]=h?.username,e[9]=O):O=e[9];let k=O,{data:A}=fe(l?.id,k),j;e[10]===A?j=e[11]:(j=A===void 0?[]:A,e[10]=A,e[11]=j);let M=j,{mutate:Ee}=_e(),N,P;e[12]!==u||e[13]!==k||e[14]!==l?(N=()=>{if(!l)return;let e=d.channel(`chat_messages_realtime`).on(`postgres_changes`,{event:`INSERT`,schema:`public`,table:`messages`},e=>{let t=e.new;if(t.receiver_id!==l.id&&t.sender_id!==l.id)return;u.invalidateQueries({queryKey:[`conversations`]}),console.log(`Realtime msg:`,t,`Selected:`,k);let n=t.sender_id===k&&t.receiver_id===l.id||t.sender_id===l.id&&t.receiver_id===k;k&&n&&(u.setQueryData(m(k),e=>e&&e.some(e=>e.id===t.id)?e:e?[...e,t]:[t]),u.invalidateQueries({queryKey:m(k)}))}).subscribe();return()=>{d.removeChannel(e)}},P=[l,k,u],e[12]=u,e[13]=k,e[14]=l,e[15]=N,e[16]=P):(N=e[15],P=e[16]),(0,f.useEffect)(N,P);let F;e[17]!==_||e[18]!==h||e[19]!==k||e[20]!==Ee||e[21]!==l?(F=()=>{if(console.log(`Attempting to send message:`,_,k,l?.id,h),!_.trim()||!k||!l){console.warn(`Send aborted: Missing data`,{msg:_,target:k,user:l?.id,selectedObject:h});return}Ee({content:_,senderId:l.id,receiverId:k}),be(``)},e[17]=_,e[18]=h,e[19]=k,e[20]=Ee,e[21]=l,e[22]=F):F=e[22];let De=F,I;e[23]===Symbol.for(`react.memo_cache_sentinel`)?(I=()=>{Te.current?.scrollIntoView({behavior:`smooth`})},e[23]=I):I=e[23];let L;e[24]===M?L=e[25]:(L=[M],e[24]=M,e[25]=L),(0,f.useEffect)(I,L);let R;e[26]===p?R=e[27]:(R=e=>{p(`/messages/${e.username}`,{state:{user:e}})},e[26]=p,e[27]=R);let Oe=R,ke=`w-full h-full md:border ${x} rounded-lg flex overflow-hidden relative shadow-lg`,Ae=`w-full md:w-[397px] border-r ${x} flex flex-col absolute md:relative inset-0 z-10 ${o===`dark`?`bg-black`:`bg-white`} ${h?`hidden md:flex`:`flex`}`,je=`h-[75px] px-5 flex items-center justify-between border-b ${x} shrink-0`,z;e[28]===p?z=e[29]:(z=()=>p(`/`),e[28]=p,e[29]=z);let Me;e[30]===Symbol.for(`react.memo_cache_sentinel`)?(Me=(0,g.jsx)(n,{size:28}),e[30]=Me):Me=e[30];let B;e[31]===z?B=e[32]:(B=(0,g.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-1`,onClick:z,children:Me}),e[31]=z,e[32]=B);let Ne=ee?.username,V;e[33]===Ne?V=e[34]:(V=(0,g.jsx)(`span`,{className:`font-bold text-xl`,children:Ne}),e[33]=Ne,e[34]=V);let Pe;e[35]===Symbol.for(`react.memo_cache_sentinel`)?(Pe=(0,g.jsx)(i,{size:20}),e[35]=Pe):Pe=e[35];let H;e[36]===V?H=e[37]:(H=(0,g.jsxs)(`div`,{className:`flex items-center gap-2 cursor-pointer`,children:[V,Pe]}),e[36]=V,e[37]=H);let U;e[38]!==B||e[39]!==H?(U=(0,g.jsxs)(`div`,{className:`flex items-center gap-2`,children:[B,H]}),e[38]=B,e[39]=H,e[40]=U):U=e[40];let Fe;e[41]===Symbol.for(`react.memo_cache_sentinel`)?(Fe=(0,g.jsx)(ae,{size:24,className:`cursor-pointer`}),e[41]=Fe):Fe=e[41];let W;e[42]!==je||e[43]!==U?(W=(0,g.jsxs)(`div`,{className:je,children:[U,Fe]}),e[42]=je,e[43]=U,e[44]=W):W=e[44];let Ie=`flex items-center gap-2 px-3 py-2 rounded-lg ${o===`dark`?`bg-[#262626]`:`bg-gray-100`}`,Le;e[45]===Symbol.for(`react.memo_cache_sentinel`)?(Le=(0,g.jsx)(te,{size:16,className:`text-[#8e8e8e]`}),e[45]=Le):Le=e[45];let Re;e[46]===Symbol.for(`react.memo_cache_sentinel`)?(Re=e=>xe(e.target.value),e[46]=Re):Re=e[46];let G,K;e[47]===v?(G=e[48],K=e[49]):(G=(0,g.jsx)(`input`,{type:`text`,placeholder:`অনুসন্ধান`,value:v,onChange:Re,className:`bg-transparent border-none outline-none text-sm w-full placeholder-[#8e8e8e]`}),K=v&&(0,g.jsx)(re,{size:16,className:`cursor-pointer text-[#8e8e8e]`,onClick:()=>xe(``)}),e[47]=v,e[48]=G,e[49]=K);let q;e[50]!==Ie||e[51]!==G||e[52]!==K?(q=(0,g.jsx)(`div`,{className:`px-5 py-4 shrink-0`,children:(0,g.jsxs)(`div`,{className:Ie,children:[Le,G,K]})}),e[50]=Ie,e[51]=G,e[52]=K,e[53]=q):q=e[53];let J;e[54]!==S||e[55]!==D||e[56]!==Oe||e[57]!==Ce||e[58]!==v||e[59]!==b||e[60]!==h?.username||e[61]!==o?(J=v?(0,g.jsx)(g.Fragment,{children:Ce?(0,g.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`অনুসন্ধান করা হচ্ছে...`}):b.length===0?(0,g.jsx)(`div`,{className:`p-4 text-center text-sm text-gray-500`,children:`কোনো ফলাফল পাওয়া যায়নি`}):b.map(e=>(0,g.jsxs)(`div`,{onClick:()=>{Oe(e),xe(``)},className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${S}`,children:[(0,g.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,g.jsx)(se,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,g.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,g.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,g.jsx)(le,{})]}),(0,g.jsx)(`div`,{className:`text-xs truncate ${o===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:e.name})]})]},e.username))}):D.map(e=>(0,g.jsxs)(`div`,{onClick:()=>Oe(e),className:`flex items-center gap-3 px-5 py-3 cursor-pointer transition-colors ${S} ${h?.username===e.username?o===`dark`?`bg-zinc-900`:`bg-gray-100`:``}`,children:[(0,g.jsx)(`div`,{className:`relative flex-shrink-0 w-14 h-14 rounded-full overflow-hidden`,children:(0,g.jsx)(se,{src:e.avatar,className:`w-full h-full`,alt:e.username})}),(0,g.jsxs)(`div`,{className:`flex-grow min-w-0`,children:[(0,g.jsxs)(`div`,{className:`text-sm truncate font-bold flex items-center gap-1`,children:[e.username,e.isVerified&&(0,g.jsx)(le,{})]}),(0,g.jsx)(`div`,{className:`text-xs truncate ${o===`dark`?`text-[#a8a8a8]`:`text-gray-500`}`,children:`মেসেজ...`})]})]},e.username)),e[54]=S,e[55]=D,e[56]=Oe,e[57]=Ce,e[58]=v,e[59]=b,e[60]=h?.username,e[61]=o,e[62]=J):J=e[62];let Y;e[63]===J?Y=e[64]:(Y=(0,g.jsx)(`div`,{className:`flex-grow overflow-y-auto`,children:J}),e[63]=J,e[64]=Y);let X;e[65]!==Ae||e[66]!==W||e[67]!==q||e[68]!==Y?(X=(0,g.jsxs)(`div`,{className:Ae,children:[W,q,Y]}),e[65]=Ae,e[66]=W,e[67]=q,e[68]=Y,e[69]=X):X=e[69];let ze=`w-full flex-grow flex flex-col absolute md:relative inset-0 z-20 ${o===`dark`?`bg-black`:`bg-white`} ${h?`flex`:`hidden md:flex`}`,Z;e[70]!==x||e[71]!==De||e[72]!==M||e[73]!==p||e[74]!==_||e[75]!==h||e[76]!==s||e[77]!==o||e[78]!==l?.id?(Z=h?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)(`div`,{className:`h-[75px] px-4 flex items-center justify-between border-b ${x} shrink-0`,children:[(0,g.jsxs)(`div`,{className:`flex items-center gap-3`,children:[(0,g.jsx)(`div`,{className:`md:hidden cursor-pointer -ml-2 p-2`,onClick:()=>p(`/messages`),children:(0,g.jsx)(n,{size:28})}),(0,g.jsx)(`div`,{className:`w-8 h-8 rounded-full overflow-hidden cursor-pointer`,onClick:()=>p(`/profile/${h.username}`),children:(0,g.jsx)(se,{src:h.avatar,className:`w-full h-full`,alt:`chat user`})}),(0,g.jsxs)(`div`,{className:`font-semibold text-base truncate max-w-[150px] cursor-pointer hover:underline flex items-center gap-1`,onClick:()=>p(`/profile/${h.username}`),children:[h.username,h.isVerified&&(0,g.jsx)(le,{})]})]}),(0,g.jsx)(`div`,{className:`flex items-center gap-4`,children:(0,g.jsx)(r,{size:24,className:`cursor-pointer`})})]}),(0,g.jsxs)(`div`,{className:`flex-grow flex flex-col p-4 gap-4 overflow-y-auto`,children:[M.map((e,t)=>(0,g.jsx)(`div`,{className:`flex gap-2 max-w-[85%] items-end ${e.sender_id===l?.id?`self-end justify-end`:`self-start`}`,children:(0,g.jsx)(g.Fragment,{children:e.content&&(0,g.jsx)(`div`,{className:`rounded-2xl px-4 py-2 text-sm ${e.sender_id===l?.id?`bg-[#006a4e] text-white`:o===`dark`?`bg-[#262626] text-white`:`bg-gray-200 text-black`}`,children:e.content})})},e.id||t)),(0,g.jsx)(`div`,{ref:Te})]}),(0,g.jsx)(`div`,{className:`p-4 shrink-0`,children:(0,g.jsxs)(`form`,{className:`border ${x} rounded-full px-2 h-11 flex items-center gap-2 ${o===`dark`?`bg-black`:`bg-white`}`,onSubmit:e=>{e.preventDefault(),De()},children:[(0,g.jsx)(`div`,{className:`bg-[#006a4e] hover:bg-[#00523c] rounded-full p-2 cursor-pointer ml-1 text-white`,children:(0,g.jsx)(oe,{size:16,fill:`currentColor`})}),(0,g.jsx)(`input`,{type:`text`,placeholder:`মেসেজ...`,value:_,onChange:e=>be(e.target.value),className:`bg-transparent border-none outline-none text-sm flex-grow px-2 ${o===`dark`?`text-white placeholder-[#a8a8a8]`:`text-black placeholder-gray-500`}`}),(0,g.jsx)(`button`,{type:`submit`,className:`text-blue-500 font-bold px-2 cursor-pointer hover:text-blue-600 disabled:opacity-50`,disabled:!_.trim(),children:`পাঠান`})]})})]}):(0,g.jsxs)(`div`,{className:`flex flex-col items-center justify-center h-full gap-4 text-center p-8`,children:[(0,g.jsx)(`div`,{className:`w-24 h-24 rounded-full border-2 flex items-center justify-center mb-2 ${o===`dark`?`border-white`:`border-black`}`,children:(0,g.jsx)(a,{size:48,strokeWidth:1})}),(0,g.jsxs)(`div`,{children:[(0,g.jsx)(`h2`,{className:`text-xl font-normal mb-1`,children:`আপনার মেসেজ`}),(0,g.jsx)(`button`,{className:`bg-[#006a4e] hover:bg-[#00523c] text-white px-4 py-1.5 rounded-lg text-sm font-semibold`,onClick:()=>s(`বাম পাশ থেকে চ্যাট শুরু করুন`),children:`মেসেজ পাঠান`})]})]}),e[70]=x,e[71]=De,e[72]=M,e[73]=p,e[74]=_,e[75]=h,e[76]=s,e[77]=o,e[78]=l?.id,e[79]=Z):Z=e[79];let Q;e[80]!==ze||e[81]!==Z?(Q=(0,g.jsx)(`div`,{className:ze,children:Z}),e[80]=ze,e[81]=Z,e[82]=Q):Q=e[82];let $;return e[83]!==ke||e[84]!==X||e[85]!==Q?($=(0,g.jsx)(`div`,{className:`w-full flex h-full md:h-[calc(100vh-2rem)] md:pt-4 md:pb-4 md:px-4 flex-col md:flex-row`,children:(0,g.jsxs)(`div`,{className:ke,children:[X,Q]})}),e[83]=ke,e[84]=X,e[85]=Q,e[86]=$):$=e[86],$};function ye(e){return{id:e.id,username:e.username,name:e.full_name||e.username,avatar:e.avatar_url||``,isVerified:e.is_verified||!1}}export{_ as default};